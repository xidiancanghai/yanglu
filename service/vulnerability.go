package service

import (
	"database/sql"
	"errors"
	"yanglu/config"
	"yanglu/service/model"

	"github.com/sirupsen/logrus"
)

type VulnerabilityService struct {
	uid      int
	hostInfo *model.HostInfo
}

func NewVulnerabilityService(uid int, ip string) (*VulnerabilityService, error) {
	h, err := model.NewHostInfo().GetHostInfoByIp(ip)
	if err != nil {
		return nil, err
	}
	if config.IsCloud() && h.Uid != uid {
		return nil, errors.New("你不是该台主机管理员")
	}
	return &VulnerabilityService{uid: uid, hostInfo: h}, nil
}

func NewEmptyVulnerabilityService() *VulnerabilityService {
	return &VulnerabilityService{}
}

func (vs *VulnerabilityService) GetGetVulnerabilityInfo() ([]map[string]interface{}, error) {
	vl := model.NewVulnerabilityLog()
	maxId, err := vl.GetMaxTaskItemId(vs.hostInfo.Ip)
	if err != nil && err != sql.ErrNoRows {
		logrus.Error("GetGetVulnerabilityInfo err ", err)
		return nil, err
	}

	if err != nil && err == sql.ErrNoRows {
		return []map[string]interface{}{}, nil
	}

	list, err := model.NewVulnerabilityLog().GetLastLog(vs.hostInfo.Ip, maxId)
	if err != nil {
		logrus.Error("GetGetVulnerabilityInfo err ", err)
		return nil, err
	}
	rList := make([]map[string]interface{}, len(list))
	for k, v := range list {
		rList[k] = map[string]interface{}{
			"vulnerability_id":  v.VulnerabilityId,
			"pkg_name":          v.PkgName,
			"installed_version": v.InstalledVersion,
			"severity":          v.Severity,
			"fixed_version":     v.FixedVersion,
		}
	}
	return rList, nil
}

func (vs *VulnerabilityService) VulnerabilityDistribute(uid int) (interface{}, error) {
	hosts, err := model.NewHostInfo().ListAll()
	if err != nil {
		logrus.Error("VulnerabilityDistribute err ", err)
		return nil, err
	}
	list := []*model.HostInfo{}
	if config.IsCloud() {
		for k, v := range hosts {
			if v.Uid == uid {
				list = append(list, hosts[k])
			}
		}
		hosts = list
	}
	if len(hosts) == 0 {
		return nil, errors.New("暂未有任何机器")
	}
	ips := make([]string, len(hosts))
	for k, v := range hosts {
		ips[k] = v.Ip
	}
	maxItemIds, err := model.NewVulnerabilityLog().GetLastTaskItemId(ips)
	if err != nil {
		logrus.Error("VulnerabilityDistribute err ", err)
		return nil, err
	}
	if len(maxItemIds) == 0 {
		return nil, errors.New("当前未有任何检查结果")
	}
	distribute, err := model.NewVulnerabilityLog().VulnerabilityIdDistribute(ips, maxItemIds)
	if err != nil {
		logrus.Error("VulnerabilityDistribute err ", err)
		return nil, err
	}
	return distribute, nil
}
